# GPT-4.1 – Seguridad y Backend Complejo

## Contexto
Encárgate de los cambios con mayor riesgo arquitectónico o de seguridad:
1. **Eliminar o blindar `/api/test/product/:id`**.
2. **Proteger `/api/admin/analytics/vitals` y endurecer el buffer.**
3. **Conectar `checkoutStore.processOrder` al backend (sin pasarela de pago todavía).**
4. **Dejar lista la ruta `/system/:systemId`.**

## Dependencias
- Ejecutar `npm install` en raíz y `backend` si no está hecho.
- Asegurarse de que `backend/src/services/productService.ts` expone los métodos necesarios.

## Paso a paso
### 1. Endpoint `/api/test/product/:id`
- Modificar `backend/src/routes/test.ts` para que sólo se registre en `NODE_ENV === 'development'` **y** tras `requireRole('admin')`.
- Evitar `new Database('./data/store.db')`; reutiliza `productService`. Si el endpoint es innecesario, elimínalo y quita el registro desde `buildApp`.
- Añade test en `backend/src/routes/__tests__/test-route.spec.ts` (usar Fastify `inject`).

### 2. `/api/admin/analytics/vitals`
- Añade `preHandler: [requireRole('admin')]` y `config: { rateLimit: createRateLimitConfig('admin') }`.
- Limita `vitalsStore` a 500 entradas y descarta payloads > 10 KB (validarlo con Zod `z.string().max(10000)`).
- Crear pruebas unitarias para: a) rechazar payload grande b) 403 sin auth c) buffer truncado.

### 3. Checkout real
- En `src/store/checkoutStore.ts`, importar `OrderService` y reemplazar la simulación por `OrderService.placeOrder`. Construir `CreateOrderData` a partir del carrito (usa helpers si existen o crea `mapCartToOrderPayload`).
- Manejar errores HTTP mostrando `showErrorNotification(response.message)` y loggear en `errorLogger`.
- Backend: revisar `backend/src/routes/v1/orders.ts` para asegurar que funciona con peticiones anónimas (ya soporta usuario opcional). No tocar lógica de pago.
- Crear pruebas:
  - Frontend: actualizar `src/pages/__tests__/CheckoutPage.test.tsx` para mockear `OrderService.placeOrder`.
  - E2E (Playwright): nuevo escenario `e2e/checkout.spec.ts` que añade producto, llena formulario y espera status 201 (puede usar MSW o fixtures backend).

### 4. `/api/v1/products/system/:systemId`
- Quitar la validación de body en `preHandler`. Mantener únicamente la de query.
- Añadir test en `backend/src/routes/v1/__tests__/products-system.spec.ts` asegurando que responde 200.

## Scripts a ejecutar
```bash
# Desde la raíz
yarn lint || npm run lint
npm run type-check
npm run test:ci
npm run test:e2e -- --grep checkout # si se agrega el caso

# Backend
cd backend
npm run lint
npm run test:ci
```

## Criterios de éxito
- Ninguna ruta sensible accesible sin auth.
- Checkout crea órdenes en la base de datos (verifica con consulta manual o log `OrderService`).
- Tests nuevos y existentes en verde.
- Documentación actualizada (`fix-plan.md` si cambias alcance).

## Verificación / Logs
- Adjunta en PR los logs de `npm run test:ci` y `backend/npm run test:ci`.
- Para checkout, mostrar respuesta del backend (log en consola o test) con `orderId` real.
- Para analytics, mostrar captura de la petición 403.
