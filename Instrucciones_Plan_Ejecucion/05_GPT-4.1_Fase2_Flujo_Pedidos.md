# GPT-4.1 – Fase 2 (Flujo de pedidos y validaciones)

## Contexto
La Fase 1 quedó cerrada (endpoints críticos y checkout conectado). Ahora toca endurecer el flujo de pedidos y las dependencias compartidas FE/BE para que el checkout funcione igual online/offline y toda la app use imágenes optimizadas.

### Objetivos de esta fase
1. **P1 – Checkout real + Service Worker**  
   - Refinar `checkoutStore` y `OrderService` para trabajar 100 % con `/api/v1/orders`.  
   - Ajustar el Service Worker y los helpers de resync para que las órdenes se reintenten cuando el usuario está offline.  
2. **P2 – Service Worker versionado**  
   - Todas las rutas caché deben apuntar a `/api/v1/**`.  
   - Añadir `ignoreURLParametersMatching` para evitar misses por UTM/`cacheBust`.  
   - Validar que `BackgroundSyncPlugin` use la cola correcta (`orders-queue`).  
3. **P3 – Imágenes optimizadas**  
   - Centralizar `srcset` usando `OptimizedImage`/`generateSrcSet`.  
   - Apuntar datasets/props a `/public/optimized/**` siempre que exista un asset.  
   - Reducir duplicación de `<picture>` manual en Cart, Checkout, Blog, ServicePage, SystemCard.  

## Checklist de trabajo (GPT-4.1)

### 1. Verificación inicial
- [ ] `npm install` en raíz y `backend` (si no está hecho).
- [ ] Confirmar `.env` y `backend/.env` presentes (no modificarlos).
- [ ] Leer `fix-plan.md` – sección **Fase 2** (P1, P2, P3) y `FASE_2_PLAN.md` para dependencias.

### 2. Tarea P1 – Checkout y Service Worker
- [ ] Revisa `src/store/checkoutStore.ts` y `src/services/orderService.ts`. Asegura que:
  - Se genera `CreateOrderData` completo (`items`, `shippingAddress`, `paymentMethod`, `summary`).
  - `OrderService` usa `/api/v1/orders` y lanza errores detallados.
- [ ] Añade logs/telemetría (si aplica) en `orderService.placeOrder` para detectar fallos.
- [ ] Extiende el Service Worker (`src/service-worker.ts`):
  - Background sync: `registerRoute` → `/api/v1/orders`, con `BackgroundSyncPlugin('orders-queue', …)`.
  - Opcional: notificación al usuario cuando la orden quede encolada/offline.
- [ ] Scripts/Pruebas:
  - `npm run test:ci -- src/store/__tests__/checkoutStore.test.ts`.
  - `npm run test:e2e -- --grep "Checkout Flow"` (puede usarse `--project=chromium` para acelerar).

### 3. Tarea P2 – Rutas versionadas y precache
- [ ] En `src/service-worker.ts`:
  - Precache: `precacheAndRoute(self.__WB_MANIFEST, { ignoreURLParametersMatching: [/^utm_/, …] })`.
  - Cambiar selectores a `/api/v1/products` y `/api/v1/orders`.
  - Revisar `NetworkFirst`/`StaleWhileRevalidate` para que los caches usen nombres coherentes (ej. `api-products-v1`).
- [ ] Añadir pruebas manuales (docs/log) o script Workbox si existe.

### 4. Tarea P3 – Imágenes optimizadas
- [ ] Usa `OptimizedImage` en:
  - `src/pages/CartPage.tsx`
  - `src/pages/CheckoutPage.tsx`
  - `src/pages/BlogPage.tsx`
  - `src/pages/BlogPostPage.tsx`
  - `src/pages/ServicePage.tsx`
  - `src/components/SystemCard.tsx`
- [ ] Si algún dataset (`src/data/services.ts`, `src/data/blog.ts`, etc.) apunta a rutas antiguas (`/images/...`), mapéalas al folder `/optimized/`. Documenta los casos en `fix-plan.md` si falta asset.
- [ ] Tests recomendados:
  - `npm run lint`
  - `npx vitest run src/utils/__tests__/normalizeSrcSet.spec.ts`

### 5. Entregables/Firma
- [ ] Evidencias (capturas/logs) de:
  - `npm run test:ci -- src/store/__tests__/checkoutStore.test.ts`
  - `npm run test:e2e -- --grep "Checkout"` (si se ejecuta)
  - `backend/npm run test:once` (solo si tocaste backend)
- [ ] Actualiza `fix-plan.md` (sección Fase 2) con lo implementado.
- [ ] Anota cualquier pendencia o follow-up en `Instrucciones_Plan_Ejecucion/README.md` o en el mismo archivo de instrucciones.

## Notas
- Cualquier cambio en assets grandes: usa `/public/optimized` y respeta los nombres del script `optimizeImages`.
- Mantén comunicación con Codex para validar cuando cerrar/abrir sub-fases.
- No avances a PWA/Lighthouse (Fase 3) hasta que Codex confirme que P1–P3 de Fase 2 están listos.
