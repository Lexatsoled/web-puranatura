name: Validate required repo secrets

on:
  # Run on pull requests targeting main, and when main receives a push.
  # Keep the ability to run this manually for admins/maintainers via workflow_dispatch.
  pull_request:
    branches: [main]
    # avoid running this on PRs that only change workflow files (noise)
    paths-ignore:
      - '.github/**'
  push:
    branches: [main]
    # avoid running this check on commits that only change workflow files
    paths-ignore:
      - '.github/**'
  workflow_dispatch: {}

permissions:
  contents: read
  secrets: read

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    name: Ensure required secrets are set
    # Run the failing check only for pushes to main; for PRs we warn (non-blocking)
    if: "${{ github.event_name != 'push' || github.ref == 'refs/heads/main' }}"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets are present
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const path = '.github/required-secrets.yml';
            if (!fs.existsSync(path)) {
              throw new Error('required-secrets.yml is missing in .github');
            }
            const content = fs.readFileSync(path, 'utf8')
              .split('\n')
              // strip leading dashes/spaces, remove inline/full comments, trim and ignore blank lines
              .map(s => s.replace(/^[\s-]+/, '').replace(/#.*/g, '').trim())
              .filter(Boolean);

            console.log('Required secrets list:', content.join(', '));

            let data;
            try {
              const res = await github.rest.actions.listRepoSecrets({
                owner: context.repo.owner,
                repo: context.repo.repo,
              });
              data = res.data;
            } catch (err) {
              if (context.eventName === 'pull_request') {
                console.warn('Could not read repo secrets in PR context, continuing as warning:', err.message || err);
                data = { secrets: [] };
              } else {
                throw err;
              }
            }

            const present = new Set(data.secrets.map(s=>s.name));
            const missing = content.filter(x => !present.has(x));
            if (missing.length) {
              // If this is a pull_request (common when the contributor's branch or fork
              // doesn't have access to repo secrets), treat missing secrets as a warning
              // and do not fail. For push events to main, fail hard so admins must fix repo secrets.
              if (context.eventName === 'pull_request') {
                console.warn('Required secrets missing (PR context - warning): ' + missing.join(', '));
              } else {
                throw new Error('Required secrets missing: ' + missing.join(', '));
              }
            }
            console.log('All required secrets present');
