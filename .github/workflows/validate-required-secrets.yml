name: Validate required repo secrets

on:
  # Run on pull requests targeting main, and when main receives a push.
  # Keep the ability to run this manually for admins/maintainers via workflow_dispatch.
  pull_request:
    branches: [main]
  push:
    branches: [main]
    # avoid running this check on commits that only change workflow files
    paths-ignore:
      - '.github/**'
  workflow_dispatch: {}

permissions:
  contents: read
  secrets: read

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    name: Ensure required secrets are set
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required secrets are present
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = '.github/required-secrets.yml';
            if (!fs.existsSync(path)) {
              throw new Error('required-secrets.yml is missing in .github');
            }
            const content = fs.readFileSync(path, 'utf8')
              .split('\n')
              .map(s => s.replace(/^[\s-]+/,'').trim())
              .filter(Boolean);

            console.log('Required secrets list:', content.join(', '));

            const { data } = await github.rest.actions.listRepoSecrets({
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const present = new Set(data.secrets.map(s=>s.name));
            const missing = content.filter(x => !present.has(x));
            if (missing.length) {
              throw new Error('Required secrets missing: ' + missing.join(', '));
            }
            console.log('All required secrets present');
