name: Dependabot alerts — HIGH/CRITICAL handler

on:
  schedule:
    - cron: '0 6 * * *' # daily at 06:00 UTC
  workflow_dispatch: {}
  push:
    branches: [main]
    paths-ignore:
      - '.github/**'

permissions:
  issues: write
  security-events: read

jobs:
  on-high-critical:
    name: Create issue for HIGH/CRITICAL Dependabot alerts
    runs-on: ubuntu-latest
    steps:
      - name: Select token (PAT preferred)
        id: token
        shell: bash
        run: |
          if [ -n "${{ secrets.DEPENDABOT_TOKEN }}" ]; then
            echo "value=${{ secrets.DEPENDABOT_TOKEN }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=${{ github.token }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Handle Dependabot HIGH/CRITICAL alerts
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.token.outputs.value }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            try {
              const res = await github.request('GET /repos/{owner}/{repo}/dependabot/alerts', { owner, repo, state: 'open' });
              const alerts = res.data || [];
              core.info(`Found ${alerts.length} Dependabot alerts (open)`);

              for (const alert of alerts) {
                const severity = (alert.security_advisory?.severity || alert.severity || '').toLowerCase();
                if (severity !== 'high' && severity !== 'critical') continue;

                const pkg = alert.dependency?.package?.name || alert.security_advisory?.package?.name || alert.package || 'dependency';
                const title = `Security: Dependabot ${severity.toUpperCase()} alert — ${pkg}`;

                const { data: issues } = await github.rest.issues.listForRepo({ owner, repo, state: 'open' });
                if (issues.find(i => i.title === title)) {
                  core.info(`Issue already exists for ${title} — skipping`);
                  continue;
                }

                const body = `Dependabot detected a **${severity.toUpperCase()}** alert for ${pkg}.\n\n` +
                  `-- Dependabot alert details --\n` +
                  `- Ecosystem: ${alert.dependency?.ecosystem || alert.security_advisory?.ecosystem || 'unknown'}\n` +
                  `- Affected version: ${alert.dependency?.vulnerable_version_range || alert.installed_version || alert.security_advisory?.vulnerable_version_range || 'unknown'}\n` +
                  `- Advisory: ${alert.security_advisory?.summary || alert.summary || 'No advisory text available.'}\n\n` +
                  `Please triage and create a remediation plan (bump, patch, or mitigation).`;

                const created = await github.rest.issues.create({ owner, repo, title, body, labels: ['security', 'dependabot', `severity:${severity}`] });
                core.info(`Created issue #${created.data.number} for ${pkg}`);
              }
            } catch (err) {
              if (err && err.status === 403) {
                core.setFailed('Dependabot API returned 403: resource not accessible by integration.\n\nTo fix: Create a personal access token (PAT) with repo + security_events scope and add it as DEPENDABOT_TOKEN secret.');
              } else {
                throw err;
              }
            }

